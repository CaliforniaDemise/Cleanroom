--- before/net/minecraft/inventory/ContainerEnchantment.java
+++ after/net/minecraft/inventory/ContainerEnchantment.java
@@ -24,25 +24,14 @@
 
 public class ContainerEnchantment extends Container
 {
-    public IInventory field_75168_e = new InventoryBasic("Enchant", true, 2)
-    {
-        public int func_70297_j_()
-        {
-            return 64;
-        }
-        public void func_70296_d()
-        {
-            super.func_70296_d();
-            ContainerEnchantment.this.func_75130_a(this);
-        }
-    };
+    public IInventory field_75168_e;
     private final World field_75172_h;
     private final BlockPos field_178150_j;
-    private final Random field_75169_l = new Random();
+    private final Random field_75169_l;
     public int field_178149_f;
-    public int[] field_75167_g = new int[3];
-    public int[] field_185001_h = new int[] { -1, -1, -1};
-    public int[] field_185002_i = new int[] { -1, -1, -1};
+    public int[] field_75167_g;
+    public int[] field_185001_h;
+    public int[] field_185002_i;
 
     @SideOnly(Side.CLIENT)
     public ContainerEnchantment(InventoryPlayer p_i45797_1_, World p_i45797_2_)
@@ -52,6 +41,22 @@
 
     public ContainerEnchantment(InventoryPlayer p_i45798_1_, World p_i45798_2_, BlockPos p_i45798_3_)
     {
+        this.field_75168_e = new InventoryBasic("Enchant", true, 2)
+        {
+            public int func_70297_j_()
+            {
+                return 64;
+            }
+            public void func_70296_d()
+            {
+                super.func_70296_d();
+                ContainerEnchantment.this.func_75130_a(this);
+            }
+        };
+        this.field_75169_l = new Random();
+        this.field_75167_g = new int[3];
+        this.field_185001_h = new int[] { -1, -1, -1};
+        this.field_185002_i = new int[] { -1, -1, -1};
         this.field_75172_h = p_i45798_2_;
         this.field_178150_j = p_i45798_3_;
         this.field_178149_f = p_i45798_1_.field_70458_d.func_175138_ci();
@@ -68,9 +73,12 @@
         });
         this.func_75146_a(new Slot(this.field_75168_e, 1, 35, 47)
         {
+            java.util.List<ItemStack> ores = net.minecraftforge.oredict.OreDictionary.getOres("gemLapis");
             public boolean func_75214_a(ItemStack p_75214_1_)
             {
-                return p_75214_1_.func_77973_b() == Items.field_151100_aR && EnumDyeColor.func_176766_a(p_75214_1_.func_77960_j()) == EnumDyeColor.BLUE;
+                for (ItemStack ore : ores)
+                    if (net.minecraftforge.oredict.OreDictionary.itemMatches(ore, p_75214_1_, false)) return true;
+                return false;
             }
         });
 
@@ -155,6 +163,7 @@
                 if (!this.field_75172_h.field_72995_K)
                 {
                     int l = 0;
+                    float power = 0;
 
                     for (int j = -1; j <= 1; ++j)
                     {
@@ -162,37 +171,14 @@
                         {
                             if ((j != 0 || k != 0) && this.field_75172_h.func_175623_d(this.field_178150_j.func_177982_a(k, 0, j)) && this.field_75172_h.func_175623_d(this.field_178150_j.func_177982_a(k, 1, j)))
                             {
-                                if (this.field_75172_h.func_180495_p(this.field_178150_j.func_177982_a(k * 2, 0, j * 2)).func_177230_c() == Blocks.field_150342_X)
-                                {
-                                    ++l;
-                                }
-
-                                if (this.field_75172_h.func_180495_p(this.field_178150_j.func_177982_a(k * 2, 1, j * 2)).func_177230_c() == Blocks.field_150342_X)
-                                {
-                                    ++l;
-                                }
-
+                                power += net.minecraftforge.common.ForgeHooks.getEnchantPower(field_75172_h, field_178150_j.func_177982_a(k * 2, 0, j * 2));
+                                power += net.minecraftforge.common.ForgeHooks.getEnchantPower(field_75172_h, field_178150_j.func_177982_a(k * 2, 1, j * 2));
                                 if (k != 0 && j != 0)
                                 {
-                                    if (this.field_75172_h.func_180495_p(this.field_178150_j.func_177982_a(k * 2, 0, j)).func_177230_c() == Blocks.field_150342_X)
-                                    {
-                                        ++l;
-                                    }
-
-                                    if (this.field_75172_h.func_180495_p(this.field_178150_j.func_177982_a(k * 2, 1, j)).func_177230_c() == Blocks.field_150342_X)
-                                    {
-                                        ++l;
-                                    }
-
-                                    if (this.field_75172_h.func_180495_p(this.field_178150_j.func_177982_a(k, 0, j * 2)).func_177230_c() == Blocks.field_150342_X)
-                                    {
-                                        ++l;
-                                    }
-
-                                    if (this.field_75172_h.func_180495_p(this.field_178150_j.func_177982_a(k, 1, j * 2)).func_177230_c() == Blocks.field_150342_X)
-                                    {
-                                        ++l;
-                                    }
+                                    power += net.minecraftforge.common.ForgeHooks.getEnchantPower(field_75172_h, field_178150_j.func_177982_a(k * 2, 0, j));
+                                    power += net.minecraftforge.common.ForgeHooks.getEnchantPower(field_75172_h, field_178150_j.func_177982_a(k * 2, 1, j));
+                                    power += net.minecraftforge.common.ForgeHooks.getEnchantPower(field_75172_h, field_178150_j.func_177982_a(k, 0, j * 2));
+                                    power += net.minecraftforge.common.ForgeHooks.getEnchantPower(field_75172_h, field_178150_j.func_177982_a(k, 1, j * 2));
                                 }
                             }
                         }
@@ -202,7 +188,7 @@
 
                     for (int i1 = 0; i1 < 3; ++i1)
                     {
-                        this.field_75167_g[i1] = EnchantmentHelper.func_77514_a(this.field_75169_l, i1, l, itemstack);
+                        this.field_75167_g[i1] = EnchantmentHelper.func_77514_a(this.field_75169_l, i1, (int)power, itemstack);
                         this.field_185001_h[i1] = -1;
                         this.field_185002_i[i1] = -1;
 
@@ -210,6 +196,7 @@
                         {
                             this.field_75167_g[i1] = 0;
                         }
+                        this.field_75167_g[i1] = net.minecraftforge.event.ForgeEventFactory.onEnchantmentLevelSet(field_75172_h, field_178150_j, i1, (int)power, itemstack, field_75167_g[i1]);
                     }
 
                     for (int j1 = 0; j1 < 3; ++j1)
@@ -353,7 +340,7 @@
         }
         else
         {
-            return !(p_75145_1_.func_70092_e((double)this.field_178150_j.func_177958_n() + 0.5D, (double)this.field_178150_j.func_177956_o() + 0.5D, (double)this.field_178150_j.func_177952_p() + 0.5D) > 64.0D);
+            return p_75145_1_.func_70092_e((double)this.field_178150_j.func_177958_n() + 0.5D, (double)this.field_178150_j.func_177956_o() + 0.5D, (double)this.field_178150_j.func_177952_p() + 0.5D) <= 64.0D;
         }
     }
 
@@ -390,19 +377,18 @@
             }
             else
             {
-                if (this.field_75151_b.get(0).func_75216_d() || !this.field_75151_b.get(0).func_75214_a(itemstack1))
+                if (((Slot)this.field_75151_b.get(0)).func_75216_d() || !((Slot)this.field_75151_b.get(0)).func_75214_a(itemstack1))
                 {
                     return ItemStack.field_190927_a;
                 }
 
-                if (itemstack1.func_77942_o() && itemstack1.func_190916_E() == 1)
+                if (itemstack1.func_77942_o())// Forge: Fix MC-17431
                 {
-                    this.field_75151_b.get(0).func_75215_d(itemstack1.func_77946_l());
-                    itemstack1.func_190920_e(0);
+                    ((Slot)this.field_75151_b.get(0)).func_75215_d(itemstack1.func_77979_a(1));
                 }
                 else if (!itemstack1.func_190926_b())
                 {
-                    this.field_75151_b.get(0).func_75215_d(new ItemStack(itemstack1.func_77973_b(), 1, itemstack1.func_77960_j()));
+                    ((Slot)this.field_75151_b.get(0)).func_75215_d(new ItemStack(itemstack1.func_77973_b(), 1, itemstack1.func_77960_j()));
                     itemstack1.func_190918_g(1);
                 }
             }
